name: Security Scan (Official + Reports)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    permissions:
      contents: read
      security-events: write

    steps:
      # ---------- Checkout ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Prepare Reports Folder ----------
      - name: Prepare reports folder
        run: mkdir -p reports

      # ---------- Initialize CodeQL v4 ----------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript  # JS + EJS

      # ---------- Run CodeQL ----------
      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          output: reports/codeql-results.sarif

      # ---------- Trivy Filesystem Scan ----------
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: json
          output: reports/trivy-report.json

      # ---------- Gitleaks Secret Scan ----------
      - name: Gitleaks secret scan
        uses: zricethezav/gitleaks-action@v1.3.0
        continue-on-error: true
        with:
          args: "--redact --verbose --report-format json --report-path reports/gitleaks-report.json"

      # ---------- Quick Git-based Secret Check ----------
      - name: Quick Git secrets heuristic
        continue-on-error: true
        run: |
          echo "Scanning last 20 commits for secrets..." > reports/quick-secrets.txt
          git log -n 20 --oneline | grep -E "password|secret|token|apikey|api_key|access_key" >> reports/quick-secrets.txt || echo "No secrets found" >> reports/quick-secrets.txt

      # ---------- Generate Quick Markdown Report ----------
      - name: Generate Quick Security Report
        run: |
          echo "# ðŸš€ Quick Security Scan Report" > reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> reports/quick-scan.md
          echo "**Branch:** ${{ github.ref_name }}" >> reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "## âœ… Scans Performed" >> reports/quick-scan.md
          echo "- CodeQL (v4, JavaScript/EJS)" >> reports/quick-scan.md
          echo "- Trivy filesystem scan" >> reports/quick-scan.md
          echo "- Gitleaks secret scan" >> reports/quick-scan.md
          echo "- Quick git secrets heuristic" >> reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "## ðŸ“„ Report Files" >> reports/quick-scan.md
          echo "- CodeQL SARIF: reports/codeql-results.sarif" >> reports/quick-scan.md
          echo "- Trivy report: reports/trivy-report.json" >> reports/quick-scan.md
          echo "- Gitleaks report: reports/gitleaks-report.json" >> reports/quick-scan.md
          echo "- Quick secrets heuristic: reports/quick-secrets.txt" >> reports/quick-scan.md

      # ---------- Upload Reports ----------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
