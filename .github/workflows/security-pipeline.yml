name: Security Scan (Full Web API Coverage)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write

    steps:
      # ---------- Checkout ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Prepare Reports ----------
      - name: Prepare reports folder
        run: mkdir -p reports


      #  SAST — CodeQL (Official)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          output: reports/codeql-results.sarif

      # SCA — Trivy (Dependencies + FS)
      - name: Trivy filesystem & dependency scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: sarif
          output: reports/trivy.sarif

      - name: Upload Trivy SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/trivy.sarif


      #  Secrets — Gitleaks
      - name: Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        with:
          args: >
            detect
            --redact
            --report-format sarif
            --report-path reports/gitleaks.sarif

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/gitleaks.sarif

      #  IaC — Checkov (Terraform, Docker, K8s, GitHub Actions)
      - name: Run Checkov IaC scan
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: reports/checkov.sarif

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/checkov.sarif

      #  DAST — OWASP ZAP (API running locally)
      - name: Install dependencies
        run: npm install

      - name: Start API
        run: |
          npm start &
          sleep 15

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: http://localhost:3000
          cmd_options: "-r reports/zap-report.html"

      #  Upload Reports
      - name: Upload all security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
