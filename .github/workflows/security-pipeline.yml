name: Security Scan (Full Web API Coverage)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      # ---------- Checkout ----------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for Gitleaks to scan commit history

      # ---------- Prepare Reports ----------
      - name: Prepare reports folder
        run: mkdir -p reports

      # SAST — CodeQL (Official)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:javascript

      # SCA — Trivy (Dependencies + FS)
      - name: Trivy filesystem & dependency scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          format: 'sarif'
          output: 'reports/trivy.sarif'

      - name: Upload Trivy SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: reports/trivy.sarif

      # Secrets — Gitleaks (Fixed)
      - name: Gitleaks secret scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # If using Pro version
        continue-on-error: true

      # Process Gitleaks output and create SARIF manually
      - name: Process Gitleaks results
        if: always() && steps.gitleaks.outcome == 'success'
        run: |
          # If Gitleaks doesn't create SARIF directly, you might need to convert
          # For now, let's ensure the reports folder exists
          mkdir -p reports
          # Check if Gitleaks generated any output
          if [ -f "gitleaks-report.sarif" ]; then
            mv gitleaks-report.sarif reports/gitleaks.sarif
          else
            echo '{"runs": []}' > reports/gitleaks.sarif
          fi

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: reports/gitleaks.sarif

      # IaC — Checkov (Terraform, Docker, K8s, GitHub Actions)
      - name: Run Checkov IaC scan
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: '.'
          framework: 'all'
          output_format: 'sarif'
          output_file_path: 'reports/checkov.sarif'
          soft_fail: true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: reports/checkov.sarif

      # DAST — OWASP ZAP (API running locally)
      - name: Install dependencies
        run: npm install

      - name: Start API
        run: |
          npm start &
          sleep 15

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -r -w reports/zap-report.html'

      # Upload Reports
      - name: Upload all security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: reports/