name: Security Scan (Full Web )

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write

    steps:
      # ---------- Checkout ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Prepare Reports ----------
      - name: Prepare reports folder
        run: mkdir -p reports

      # ---------- CodeQL (SAST) ----------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v4
        with:
          output: reports/codeql-results.sarif

      # ---------- Trivy (SCA / FS) ----------
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          format: json
          output: reports/trivy-report.json

      # ---------- Gitleaks (Secrets) ----------
      # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…ÙˆÙ† action Ø§ÛŒ Ú©Ù‡ Ú¯ÙØªÛŒ Â«Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯Â»
      - name: Gitleaks secret scan
        uses: zricethezav/gitleaks-action@v1.3.0
        continue-on-error: true
        with:
          args: "--redact --verbose --report-format json --report-path reports/gitleaks-report.json"

      # ---------- Quick Git Heuristic ----------
      - name: Quick Git secrets heuristic
        continue-on-error: true
        run: |
          echo "Scanning last 20 commits for secrets..." > reports/quick-secrets.txt
          git log -n 20 --oneline | grep -E "password|secret|token|apikey|api_key|access_key" \
            >> reports/quick-secrets.txt || echo "No secrets found" >> reports/quick-secrets.txt

      # ---------- Optional DAST (Local API) ----------
      - name: Install dependencies
        run: npm install
        continue-on-error: true

      - name: Start API
        run: |
          npm start &
          sleep 15
        continue-on-error: true

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: http://localhost:3000
          cmd_options: "-r reports/zap-report.html"

      # ---------- Markdown Summary ----------
      - name: Generate Quick Security Report
        run: |
          echo "# ðŸš€ Quick Security Scan Report" > reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> reports/quick-scan.md
          echo "**Branch:** ${{ github.ref_name }}" >> reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "## âœ… Scans Performed" >> reports/quick-scan.md
          echo "- CodeQL (JavaScript)" >> reports/quick-scan.md
          echo "- Trivy filesystem scan" >> reports/quick-scan.md
          echo "- Gitleaks secret scan" >> reports/quick-scan.md
          echo "- Quick git heuristic" >> reports/quick-scan.md
          echo "- OWASP ZAP baseline (DAST)" >> reports/quick-scan.md
          echo "" >> reports/quick-scan.md
          echo "## ðŸ“„ Report Files" >> reports/quick-scan.md
          echo "- CodeQL SARIF: reports/codeql-results.sarif" >> reports/quick-scan.md
          echo "- Trivy: reports/trivy-report.json" >> reports/quick-scan.md
          echo "- Gitleaks: reports/gitleaks-report.json" >> reports/quick-scan.md
          echo "- Quick secrets: reports/quick-secrets.txt" >> reports/quick-scan.md
          echo "- ZAP: reports/zap-report.html" >> reports/quick-scan.md

      # ---------- Upload Artifacts ----------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
